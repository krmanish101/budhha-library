{% extends 'base.html' %}
{% block title %}Students{% endblock %}

{% block content %}
<div class="container mt-4">
  <h2 class="text-center mb-4">Buddha Library Telhara Nalanda</h2>

  <!-- Add Student Form -->
  <div class="card mb-4 shadow-sm">
    <div class="card-header bg-primary text-white">Add New Student</div>
    <div class="card-body">
      <form method="POST"
            action="{{ url_for('add_student') }}"
            enctype="multipart/form-data">
        <div class="row g-3">
          <div class="col-md-3">
            <input type="text" name="name" class="form-control"
                   placeholder="Student Name" required>
          </div>
          <div class="col-md-3">
            <input type="text" name="father" class="form-control"
                   placeholder="Father's Name" required>
          </div>
          <div class="col-md-3">
            <input type="text" name="phone" class="form-control"
                   placeholder="Phone Number" required>
          </div>
          <div class="col-md-3">
            <input type="text" name="address" class="form-control"
                   placeholder="Address">
          </div>

          <div class="col-md-3">
            <select name="shift" class="form-select">
              <option value="">Select Shift</option>
              {% for m in [
                '9 To 3','10 To 4','10 To 6','24/7','Night Shift','Full Day'
              ] %}
              <option value="{{ m }}">{{ m }}</option>
              {% endfor %}
            </select>
          </div>

          <div class="col-md-2">
            <input type="text" name="sheet_no" class="form-control"
                   placeholder="Sheet No">
          </div>

          <div class="col-md-3">
            <!-- Admission Month dropdown -->
            <select name="admission_month" class="form-select">
              <option value="">Admission Month</option>
              {% for m in [
                'January','February','March','April','May','June',
                'July','August','September','October','November','December'
              ] %}
              <option value="{{ m }}">{{ m }}</option>
              {% endfor %}
            </select>
          </div>

          <div class="col-md-2">
            <input type="number" step="0.01" name="fee_amount"
                   class="form-control" placeholder="Fee Amount">
          </div>

          <div class="col-md-2">
            <input type="text" name="aadhar_number"
                   class="form-control" placeholder="Aadhar Number">
          </div>

          <div class="col-md-4 mt-2">
            <input type="file" name="aadhar_image"
                   class="form-control">
          </div>
        </div>

        <div class="text-end mt-3">
          <button type="submit" class="btn btn-success">
            Add Student
          </button>
        </div>
      </form>
    </div>
  </div>
<!-- Filter bar -->
<form method="get" class="row g-2 mb-3">
  <div class="col-auto">
    <input type="text" name="name" class="form-control filter-input"
           placeholder="Name"
           value="{{ name or '' }}">
  </div>
  <div class="col-auto">
    <input type="text" name="admission_month" class="form-control filter-input"
           placeholder="Month"
           value="{{ filter_month or '' }}">
  </div>

  <div class="col-auto">
    <input type="text" name="sheet_no" class="form-control filter-input"
           placeholder="Sheet No"
           value="{{ filter_sheet or '' }}">
  </div>

  <div class="col-auto de-flex gap-2">
    <button type="submit" class="btn btn-primary filter-btn">
      Filter
    </button>

    <a href="{{ url_for('students') }}"
       class="btn btn-outline-secondary filter-Clear-btn">
      Clear
    </a>
  </div>
</form>

  <!-- Students Table -->
  <div class="card shadow-sm mb-4">
    <div class="card-header bg-dark text-white">Student Records</div>
    <div class="card-body">
      <div class="table-responsive">
        <table class="table table-bordered table-hover align-middle">
          <thead class="table-dark">
            <tr>
              <th>ID</th>
              <th>Name</th>
              <th>Father</th>
              <th>Phone</th>
              <th>Address</th>
              <th>Shift</th>
              <th>Sheet No</th>
              <th>Admission Month</th>
              <th>Fee Amount</th>
              <th>Aadhar</th>
              <th>Admission Date</th>
              <th>Aadhar Photo</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
          {% for s in students %}
            <tr>
              <td>{{ s[0] }}</td>  <!-- id -->
              <td>{{ s[1] }}</td>  <!-- name -->
              <td>{{ s[2] }}</td>  <!-- father -->
              <td>{{ s[3] }}</td>  <!-- phone -->
              <td>{{ s[4] }}</td>  <!-- address -->
              <td>{{ s[5] }}</td>  <!-- shift -->
              <td>{{ s[6] }}</td>  <!-- sheet no -->
              <td>{{ s[7] }}</td>  <!-- admission month -->
              <td>â‚¹{{ (s[8] or 0)|float }}</td> <!-- fee amount -->
              <td>{{ s[9] }}</td>  <!-- aadhar number -->
              <td>{{ s[10] }}</td> <!-- admission date -->

              <td>
                {% if s[12] %}
                  <button class="btn btn-outline-primary btn-sm"
                          data-bs-toggle="modal"
                          data-bs-target="#photoModal{{ s[0] }}">
                    View Photo
                  </button>
                {% else %}
                  <span class="text-muted">No Photo</span>
                {% endif %}
              </td>

              <td>
                <!-- EDIT BUTTON -->
                <button class="btn btn-warning btn-sm"
                        data-bs-toggle="modal"
                        data-bs-target="#editModal{{ s[0] }}">
                  Edit
                </button>

                <!-- DELETE BUTTON -->
                <form method="POST"
                      action="{{ url_for('delete_student', id=s[0]) }}"
                      style="display:inline-block;">
                  <button type="submit"
                          class="btn btn-danger btn-sm"
                          onclick="return confirm('Move this student to Old Students?');">
                    Delete
                  </button>
                </form>
              </td>
            </tr>

            <!-- Edit Modal -->
            <div class="modal fade" id="editModal{{ s[0] }}"
                 tabindex="-1" aria-hidden="true">
              <div class="modal-dialog modal-lg">
                <div class="modal-content">
                  <form method="POST"
                        action="{{ url_for('edit_student', id=s[0]) }}"
                        enctype="multipart/form-data">
                    <div class="modal-header bg-primary text-white">
                      <h5 class="modal-title">Edit Student</h5>
                      <button type="button" class="btn-close"
                              data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                      <div class="row g-3">
                        <div class="col-md-4">
                          <input type="text" name="name"
                                 class="form-control"
                                 value="{{ s[1] }}" required>
                        </div>
                        <div class="col-md-4">
                          <input type="text" name="father"
                                 class="form-control"
                                 value="{{ s[2] }}" required>
                        </div>
                        <div class="col-md-4">
                          <input type="text" name="phone"
                                 class="form-control"
                                 value="{{ s[3] }}" required>
                        </div>
                        <div class="col-md-4">
                          <input type="text" name="address"
                                 class="form-control"
                                 value="{{ s[4] }}">
                        </div>

                        <div class="col-md-3">
                          <select name="shift" class="form-select">
                            <option value="">Select shift</option>
                            {% for m in [
                              '9 To 3','10 To 4','10 To 6','24/7','Night Shift','Full Day'
                            ] %}
                              <option value="{{ m }}" {% if s[5] == m %}selected{% endif %}>
                                {{ m }}
                              </option>
                            {% endfor %}
                          </select>
                        </div>

                        <div class="col-md-2">
                          <input type="text" name="sheet_no"
                                 class="form-control"
                                 value="{{ s[6] }}">
                        </div>

                        <div class="col-md-3">
                          <select name="admission_month" class="form-select">
                            <option value="">Admission Month</option>
                            {% for m in [
                              'January','February','March','April','May','June',
                              'July','August','September','October','November','December'
                            ] %}
                              <option value="{{ m }}" {% if s[7] == m %}selected{% endif %}>
                                {{ m }}
                              </option>
                            {% endfor %}
                          </select>
                        </div>

                        <div class="col-md-2">
                          <input type="number" step="0.01"
                                 name="fee_amount"
                                 class="form-control"
                                 value="{{ s[8] }}">
                        </div>
                        <div class="col-md-4">
                          <input type="text" name="aadhar_number"
                                 class="form-control"
                                 value="{{ s[9] }}">
                        </div>

                        <div class="col-md-6">
                          <label class="form-label">Change Aadhar Photo (optional)</label>
                          <input type="file" name="aadhar_image"
                                 class="form-control">
                        </div>
                      </div>
                    </div>
                    <div class="modal-footer">
                      <button type="submit" class="btn btn-success">
                        Save Changes
                      </button>
                      <button type="button" class="btn btn-secondary"
                              data-bs-dismiss="modal">Close</button>
                    </div>
                  </form>
                </div>
              </div>
            </div>

            <!-- Aadhar Photo Modal with Zoom + Download -->
            {% if s[12] %}
            <div class="modal fade" id="photoModal{{ s[0] }}"
                 tabindex="-1" aria-hidden="true">
              <div class="modal-dialog modal-dialog-centered modal-lg">
                <div class="modal-content">
                  <div class="modal-header">
                    <h5 class="modal-title">Aadhar Photo - {{ s[1] }}</h5>
                    <button type="button" class="btn-close"
                            data-bs-dismiss="modal"></button>
                  </div>
                  <div class="modal-body text-center">

                    <!-- Zoomable Image -->
                    <img src="{{ url_for('static',
                              filename='aadhar_uploads/' ~ s[12]) }}"
                         id="aadharImg{{ s[0] }}"
                         class="img-fluid rounded mb-3"
                         style="max-height:500px; transition: transform 0.3s; cursor: zoom-in;"
                         data-scale="1">

                    <div class="d-flex justify-content-center gap-2 mt-2">
                      <!-- Zoom In -->
                      <button type="button"
                              class="btn btn-info btn-sm"
                              onclick="zoomIn('aadharImg{{ s[0] }}')">
                        Zoom In
                      </button>

                      <!-- Zoom Out -->
                      <button type="button"
                              class="btn btn-warning btn-sm"
                              onclick="zoomOut('aadharImg{{ s[0] }}')">
                        Zoom Out
                      </button>

                      <!-- Download -->
                      <a href="{{ url_for('static',
                                  filename='aadhar_uploads/' ~ s[12]) }}"
                         download
                         class="btn btn-success btn-sm">
                        Download
                      </a>
                    </div>

                  </div>
                </div>
              </div>
            </div>
            {% endif %}
          {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<!-- Simple Zoom JS -->
<script>
function zoomIn(id) {
  const img = document.getElementById(id);
  let scale = parseFloat(img.getAttribute('data-scale') || '1');
  scale += 0.2;
  if (scale > 3) scale = 3;          // max zoom
  img.style.transform = 'scale(' + scale + ')';
  img.setAttribute('data-scale', scale.toString());
  img.style.cursor = 'zoom-out';
}

function zoomOut(id) {
  const img = document.getElementById(id);
  let scale = parseFloat(img.getAttribute('data-scale') || '1');
  scale -= 0.2;
  if (scale < 1) scale = 1;          // min zoom
  img.style.transform = 'scale(' + scale + ')';
  img.setAttribute('data-scale', scale.toString());
  img.style.cursor = scale === 1 ? 'zoom-in' : 'zoom-out';
}
</script>
{% endblock %}
